<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Vanilla JS TODO App</title>
    <link href="https://cdn.jsdelivr.net/npm/bulma/css/bulma.min.css" rel="stylesheet">
    <script>

        function enableEditing(buttonElement) {
            // Find the closest <li> element
            const listItem = buttonElement.closest("li");
            const todoId = listItem.id.replace("todo-", ""); // Extract todoId from id attribute
            const text = listItem.querySelector("span").textContent; // Get the current text of the TODO

            // Clone the edit template
            const template = document.querySelector("#edit-template").content.cloneNode(true);

            template.querySelector("li").id = `todo-${todoId}`;

            // Fill template fields
            const form = template.querySelector("form");
            form.addEventListener("submit", (event) => {
                event.preventDefault();
                handleFormSubmit(form, `/edit/${todoId}`, `#todo-${todoId}`);
            });

            const input = template.querySelector("input[name='text']");
            input.value = text;

            // Set cancel logic
            template.querySelector("button.cancel").addEventListener("click", () => cancelEditing(todoId, listItem));

            // Replace the list item with the template
            listItem.replaceWith(template);
        }


        // Cancel editing logic
        function cancelEditing(todoId, originalContent) {
            const listItem = document.querySelector(`#todo-${todoId}`)
            listItem.replaceWith(originalContent)
        }


        // Handle form submissions
        const handleFormSubmit = async (form, url, target) => {
            const formData = new FormData(form)
            const response = await fetch(url, {
                method: "POST",
                body: formData,
            })

            if (response.ok) {
                document.querySelector(target).innerHTML = await response.text()
            } else {
                console.error("Failed to submit form")
            }
        }

        async function deleteTodoDOM(buttonElement) {
            // Find the closest <li> element and extract the todoId
            const listItem = buttonElement.closest("li");
            const todoId = listItem.id.replace("todo-", "");

            try {
                const response = await fetch(`/delete/${todoId}`, {
                    method: "POST"
                });

                if (response.ok) {
                    // Remove the <li> element from the DOM
                    listItem.replaceWith(await response.text());
                } else {
                    console.error("Failed to delete TODO.");
                }
            } catch (error) {
                console.error("Error while deleting TODO:", error);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {

            // Attach event listeners to add form
            const addForm = document.querySelector("form")
            addForm.addEventListener("submit", (event) => {
                event.preventDefault()
                handleFormSubmit(addForm, "/add", "#todo-list")
            })
        })
    </script>
</head>
<body>
<div class="container mt-5">
    <h1 class="title">TODO App with Vanilla JS</h1>

    <!-- Add TODO Form -->
    <form>
        <div class="field">
            <div class="control">
                <input class="input" name="todo" placeholder="Add a new task" required type="text">
            </div>
        </div>
        <button class="button is-primary" type="submit">Add TODO</button>
    </form>

    <!-- TODO List -->
    <ul class="mt-5" id="todo-list">
        {% include "partials/todo_list.html" %}
    </ul>

    <!-- Templates -->
    <template id="edit-template">
        <li>
            <form onsubmit="return false;">
                <input class="input is-small" name="text" required type="text">
                <button class="button is-small is-success" type="submit">Save</button>
                <button class="button is-small is-light cancel" type="button">Cancel</button>
            </form>
        </li>
    </template>
</div>
</body>
</html>
